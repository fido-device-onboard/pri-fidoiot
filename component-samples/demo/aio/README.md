# Getting the Executable

Use the following commands to build FIDO Device Onboard (FDO) All-In-One Component sample source.
For the instructions in this document, `<fdo-pri-src>` refers to the path of the FDO PRI folder 'pri-fidoiot'.
```
$ cd <fdo-pri-src>/component-samples/aio/
$ mvn clean install
```

This will copy the required executables and libraries into \<fdo-pri-src\>/component-samples/demo/aio/.

# Configuring the FDO PRI Owner Sample

Owner runtime arguments:

public static final String AIO_PORT = "aio_port";

- `aio_port`

  AIO HTTP server port.

  Default value: 8080

- `aio_https_port`

  AIO HTTPS server port.

  Default value: 8443

- `aio_protocol_scheme`

  Enables the service to run in https mode. Pass argument value `https` for the same. For all other values, the server service defaults to `http` scheme. .

  Default value: https

- `aio_ssl_keystore`

  Provides path for SSL keystore to be used by the service, in case it runs in HTTPS mode.
  ***NOTE***: This property is not required if service is running in `http` mode.


  Default value: ./certs/ssl.p12

- `aio_ssl_keystore-password`

  Provides password for the specified keystore.
  ***NOTE***: This property is not required if service is running in `http` mode.


  Default value: <Random generated by script>

- `aio_database_connection_url`

  JDBC URL for database connection. Includes the database driver name, port number for database, and the location of `.db` file.

  Default value: jdbc:h2:tcp://localhost:8081/./aio

- `aio_database_username"`

  AIO database username.

  Default value: sa

- `aio_database_password`
  AIO database password.

  Default value: <no-password>

- `aio_database_port`

  AIO database port number.

  Default value: 8081

- `aio_database_driver`

  JDBC driver to use.

  Default value: org.h2.Driver

- `aio_database_allow_others`

  Allow Database connection from other machines.

  Default value: false

- `aio_database_init_sql`

  The database script that will be executed when AIO server is started for the first time.

  Default value: ./init.sql

- `aio_database_new_device_sql`

  The database script that will be executed every time a new device is manufactured (DI).

  Default value: /new-device.sql

- `aio_database_new_device_sql`

  How often to check for expired protocol session information and remove it from the database. (seconds)

  Default value: 60

- `epid_online_url`

  EPID Verification Service URL for EPID device signature verification.

  Default value: https://verify.epid-sbx.trustedservices.intel.com/
  Other server options: https://verify.epid.trustedservices.intel.com/ (production EPID verification server), https://localhost:1180 (onprem verification service)

- `epid_test_mode`

  EPID devices can be tested using `Test` mode, it is intended for supporting onboarding for `development` and `test` devices. Enabling the test mode means signature verification won't be performed for the device.

  Default value: false

  ***NOTE***: True is not recommended for use in production systems.

- `catalaina.home`
  
  Tomcat configuration for Catalina home.

  Default value: ./

- `owner_ssl_keystore`

  Provides path for SSL keystore to be used by the service, in case it runs in HTTPS mode.
 
  Default value: <fdo-pri-src>/component-samples/demo/owner/certs/ssl.p12

- `owner_ssl_keystore_password`

  Provides password for the specified keystore.
 
  Default keystore password: <Random generated by script>
  
- `owner_keystore_type`

  The owner keystore type.
  
  Default value: PKCS12

- `owner_to0_rv_blob"`

  Information containing network address of the prospective owner. Owner shares this information with RV during TO0. RV, then shares the same during TO1. Device, then uses this information to initiate TO2 protocol.

  Default value: http://localhost:8042?ipaddress=127.0.0.1

- `owner_transfer_keys"`

  PEM file containing owner public keys that will be used for transfer of ownership during manufacturing.

  Default value: owner_customer1.pem

- `owner_replacement_keys"`

  PEM file container Owner public keys that will be used to replace manufactured keys during TO2 protocol.

  Default value: owner_customer1.pem

- `manufacturer_keystore_type`

  The manufacturer keystore type.

  Default value: PKCS12

- `manufacturer_keystore`

  Keystore password for manufacturer_keystore.p12 and the internal softHSM's PKCS11 keystore.

  Default value: ./manufacturer_keystore.p12
  
- `manufacturer_keystore_password`

  Keystore password for manufacturer_keystore.p12 and the internal softHSM's PKCS11 keystore.

  Default value: <Random generated by script>

- `aio_api_user"`

  Username for the database REST API calls.

  Default value: apiUser

- `aio_api_password`

  Password for the database REST API calls.

  Default value: <Random generated>

- `aio_downloads_path`

  File system path of downloads directory. see API for /downloads/<file>

  Default value: ./downloads

- `aio_auto_inject_blob`

  Auto inject RV Blob into database for TO1 protocol.

  Default value: true

## Support for OnDie Devices

Refer to [Demo README](../README.md/#configuring-ondie-optional) for steps to configure owner to support OnDie devices.

# Enabling Remote Access to DB

Remote access to H2 Sample Storage DB has been disabled by default. Enabling the access creates a security hole in the system which makes it vulnerable to Remote Code Execution.

To enable remote access to DB update the `db.tcpServer` and `webAllowOthers` properties in `\<fdo-pri-src>/component-samples/owner/src/main/java/org/fidoalliance/fdo/sample/OwnerServerApp.java` file

```
db.tcpServer = -tcp -tcpAllowOthers -ifNotExists -tcpPort <owner_db_port>
webAllowOthers = true
```

**IMPORTANT: Not recommended to enable this setting especially on production systems.**

# Starting the Owner Service

Refer to the section [Docker Commands](../README.md/#docker-commands) / [Podman Commands](../README.md/#podman-commands) to start the service.

***NOTE***: The database file located at \<fdo-pri-src\>/component-samples/demo/owner/target/data/ops.mv.db is not deleted during 'mvn clean'. As a result, the database schema and tables are persisted across docker invocations. Please delete the file manually, if you encounter any error due to persisted stale data.

# FDO PRI Owner REST APIs

| Operation                      | Description                        | Path/Query Parameters    | Content Type   |Request Body  | Response Body |
| ------------------------------:|:----------------------------------:|:------------------------:|:--------------:|-------------:|--------------:|
| GET /api/v1/owner/vouchers/    | Returns all GUID of Ownership Voucher available in `TO2_DEVICES` table. | | | | Comma-separated list of GUIDs |
| GET /api/v1/owner/vouchers/?id=<device_guid> | Returns the Ownership Voucher for the specified GUID. | Query - id: Device GUID | | | Ownership Voucher |
| POST /api/v1/owner/vouchers/ | Insert Ownership Voucher against the specified GUID in `TO2_DEVICES` table. | | application/cbor | Content of Ownership Voucher in binary format | |
| DELETE /api/v1/owner/vouchers/?id=<device_guid> | Deletes Ownership Voucher of the specified GUID from the `TO2_DEVICES` table. | Query - id: Device GUID | | | |
| GET /api/v1/owner/newvoucher/?id=<device_guid> | Returns the new Ownership Voucher for the specified GUID to enable resale. | Query - id: Device GUID | | | Ownership Voucher |
| POST /api/v1/owner/svi/settings/ | Updates the various fields of `TO2_SETTINGS` table for ID=1 field.<br/> Example input looks like 'devicemtu:=2000,ownerthreshold:=8192' | | application/text| values based on the field(s) to be modified.| |
| POST /api/v1/owner/setupinfo/?id=current_guid | updates `Replacement GUID` or `Replacement RVInfo` or `Customer ID` or all three in TO2_DEVICES table | Query - guid: current device GUID| application/text | New GUID or New RV_Info or New CUSTOMER_ID or all three. <br/> To update GUID, RV Info and CUSTOMER_ID: guid:=\<replacement_guid\>,rvinfo:=\<replacement_rvinfo\>,ownerkey:=\<customer_id\> <br/> To update Replacement GUID: guid:=\<replacement_guid\> <br/> To update Replacement RV_Info: rvinfo:=\<replacement_rvinfo\> <br/> To update CUSTOMER_ID: ownerkey:=\<customer_id\> | | |
| POST /api/v1/owner/customer/?id=<customer_id>&name=<customer_name> | Adds customer with the given ID and Public key in PEM format. | Query - id: Customer Id, name: Customer Name | text/plain; charset=us-ascii | Customer PEM formatted Public keys | |
| DELETE /api/v1/owner/customer/?id=<customer_id> | Deletes device entry from `OWNER_CUSTOMERS` table. | Query - id: Customer Id  | | | |
| GET /api/v1/device/svi/?guid=<guid> | Retieves tag information about a resoruce including id. | Query - guid: Device GUID  | | | |
| PUT /api/v1/device/svi/?module=<module-name><br>&var=<variable-name>&priority=<priority-no><br>&guid=<device-guid>&filename=\<filename\><br>&bytes=<contents-in-cbor-bytes> | Adds a new tagged resource. |  Query - module: Module Name. <br/>  var: Message Name. <br/> filename: zero length file to be created on device with the given filename. <br/> bytes: content to be populated in file, specified using filename. <br/> guid: Tag resource using GUID. <br/> device: device type tag. <br/> priority: priority order to send messages to device. <br/> os: os name tag. <br/> version: os version tag. <br/> arch: device architecture tag. <br/> crid : content resource identifier tag. <br/> hash: storing hash value of content. **NOTE** Resource will be transferred only to devices matching the tagged architecture version type. Some parameters of the API are **optional** | application/octet-stream | File to be transferred in binary format. | |
| POST /api/v1/device/svi/?id=<resource_id> | Updates the content of existing resource. | Query - id: Resource Id  | | | |
| DELETE /api/v1/device/svi/?id=<resource_id> | Removes resource(s) by tag or id. | Query - id: Resource Id  | | | |


# FDO PRI Manufacturer REST APIs

| Operation                      | Description                        | Path/Query Parameters    | Content Type   |Request Body  | Response Body |
| ------------------------------:|:----------------------------------:|:------------------------:|:--------------:|-------------:|--------------:|
| POST /api/v1/assign/?id=<customer_id>&guid=<device_guid> | Assigns customer ID to Ownership Voucher having the input GUID. | Query - id: Customer ID, guid = Device GUID | | | |
| GET /api/v1/vouchers/<serial_no> | Gets extended Ownership Voucher with the serial number. | Path - Device Serial Number | | | Ownership Voucher |
| POST /api/v1/customers/?id=<customer_id>&name=<customer_name> | Adds customer with the given ID and Public key in PEM format. | Query - id: Customer Id, name: Customer Name | text/plain; charset=us-ascii | Customer PEM formatted Public keys | |
| POST /api/v1/rvinfo/ | Updates RV Info in `MT_SETTINGS` table | | text/plain; charset=us-ascii | RV Info | | |




# FDO PRI AIO REST APIs

| Operation                      | Description                        | Path/Query Parameters    | Content Type   |Request Body  | Response Body |
| ------------------------------:|:----------------------------------:|:------------------------:|:--------------:|-------------:|--------------:|
| PUT /api/v1/uploads/<file> | PUT a file that can later be retrieved via /downloads api |  | | | |
| GET /downloads/<file> | Gets for onboarding   | | | |
| GET /api/v1/deviceinfo/{seconds} | Serves the serial no. and GUID of the devices that completed DI in the last `n` seconds | |||
| GET /api/v1/register/{guid} | registers the To0 RVBlob with the RV Server | |||


***NOTE***: These REST APIs use Digest authentication. `owner_api_user` and `owner_api_password` properties specify the credentials to be used while making the REST calls.

# Inserting Keys into Owner Keystore

The PKCS12 keystore file \<fdo-pri-src\>/component-samples/demo/owner/owner_keystore.p12 contains the default Owner keys. It contains 3 PrivateKeyEntry with algorithm types: EC-256, EC-384 and RSA-2048, and should continue to hold PrivateKeyEntry with different algorithms. To insert/replace an existing PrivateKeyEntry of any particular algorithm, refer to section [Inserting Keys into Keystore](../README.md/#inserting-keys-into-keystore) to insert new certificate/private-key pair into \<fdo-pri-src\>/component-samples/demo/owner/owner_keystore.p12.

**IMPORTANT** This is an example implementation using simplified credentials. This must be changed while performing production deployment

***NOTE***: A 'PKCS12' keystore is used to store the keys, instead of 'PKCS11' keystore (softHSM). This is because of the use of 'BouncyCastle' as a security provider for algorithm 'RSA/NONE/OAEPWithSHA256AndMGF1Padding' to support Asymmetric key exchange, since the security provider 'SUNPKCS11' configured with softHSM, does not support the same as per the available documentation.

# Troubleshooting

As the H2 DB grows, larger heap space will be required by the application to run the service. The default configured heap size is `256 MB`. Increase the heap size appropriately in `demo/owner/owner-entrypoint.sh` to avoid heap size issue
# Configuring Owner for HTTPS/TLS Communication

By default, the Owner uses HTTP for all communications on port 8042. In addition to that, the Owner can be configured to handle HTTPS requests from the device.

- Generate the Keystore/Certificate for the Owner. [REFER](https://docs.oracle.com/cd/E19509-01/820-3503/6nf1il6er/index.html)

  * Ensure that the web certificate is issued to the resolvable domain of the Owner server.

- Copy the generated Keystore/Certificate to `demo/aio/certs` folder.

- Copy the truststore containing all the required certificates to `demo/owner/certs` folder.

- Update the following environment variables in `demo/owner/aio.env` file

    |  Variable              |  Value            |             Description       |
    | -----------------------|-------------------|-------------------------------|
    | owner_protocol_scheme  | https             | To enable HTTPS communication.|
    | owner_https_port       | port number       | The given port will be used for HTTPS communication. |
    | fido_ssl_mode          | TEST / PROD       | If set to `TEST`, then SSL verification is disabled. If set to `PROD`, then certificate verification is initiated. |
    | owner_ssl_keystore     | keystore-filename | Filename of Keystore that is present in the certs folder.|
    | owner_ssl_keystore-password| keystore-password | Password of the keystore. |
    | ssl_truststore         | truststore-filename  | Filename of truststore that is present in the certs folder. Not required in `TEST` mode. |
    | ssl_truststore_password| truststore-password | Password of the truststore. Not required in `TEST` mode. |
    | ssl_truststore_type    | truststore-type   | Type of truststore. eg: JKS ,PKCS12   |
    | owner_to0_rv_blob      | to0_rv_blob       | Contains the to0_rv_blob used by device to connect with the Owner during T02. Eg: https://localhost:\<owner-https-port\>?ipaddress=127.0.0.1 |

    ***NOTE***: Appropriate security measures with respect to key-store management should be considered while performing production deployment of Owner.
    Avoid using the default keystore available for production deployment.
